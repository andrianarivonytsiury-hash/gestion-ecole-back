generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  phone      String?
  hash       String
  role       String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  students   Student[] @relation("GuardianUsers")
  teaching   Course[]  @relation("CourseTeacher")
  notifications Notification[]
}

model Class {
  id            Int       @id @default(autoincrement())
  label         String
  level         String
  academicYear  String
  students      Student[]
  courses       Course[]
  timetable     Timetable[]
}

model Student {
  id         Int       @id @default(autoincrement())
  matricule  String    @unique
  firstName  String
  lastName   String
  dossierUrl String?
  classId    Int
  class      Class     @relation(fields: [classId], references: [id])
  guardians  User[]    @relation("GuardianUsers")
  grades     Grade[]
  attendance Attendance[]
  payments   Payment[]
  finance    FinanceFlow[]
  correspondence Correspondence[]
}

model Course {
  id          Int       @id @default(autoincrement())
  subject     String
  description String?
  classId     Int
  teacherId   Int
  class       Class     @relation(fields: [classId], references: [id])
  teacher     User      @relation("CourseTeacher", fields: [teacherId], references: [id])
  timetable   Timetable[]
  grades      Grade[]
  attendance  Attendance[]
}

model Timetable {
  id        Int      @id @default(autoincrement())
  start     DateTime
  end       DateTime
  room      String
  status    String
  classId   Int
  courseId  Int
  class     Class    @relation(fields: [classId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])
}

model Holiday {
  id        Int      @id @default(autoincrement())
  label     String
  startDate DateTime
  endDate   DateTime
  type      String
}

model Attendance {
  id         Int      @id @default(autoincrement())
  status     String
  motif      String?
  notifiedAt DateTime?
  courseId   Int
  studentId  Int
  course     Course   @relation(fields: [courseId], references: [id])
  student    Student  @relation(fields: [studentId], references: [id])
}

model Grade {
  id         Int      @id @default(autoincrement())
  valeur     Float
  typeEval   String
  coeff      Float
  createdBy  Int
  updatedBy  Int?
  studentId  Int
  courseId   Int
  student    Student  @relation(fields: [studentId], references: [id])
  course     Course   @relation(fields: [courseId], references: [id])
}

model FinanceFlow {
  id         Int      @id @default(autoincrement())
  date       DateTime
  reference  String
  libelle    String
  debit      Float
  credit     Float
  solde      Float
  studentId  Int?
  moyen      String?
  statut     String?
  student    Student? @relation(fields: [studentId], references: [id])
}

model Payment {
  id          Int      @id @default(autoincrement())
  amount      Float
  currency    String
  method      String
  stripePiId  String
  status      String
  receiptUrl  String?
  studentId   Int
  student     Student  @relation(fields: [studentId], references: [id])
}

model Notification {
  id           Int      @id @default(autoincrement())
  type         String
  channel      String
  payload      Json
  status       String
  targetUserId Int
  sentAt       DateTime?
  user         User     @relation(fields: [targetUserId], references: [id])
}

model Correspondence {
  id         Int      @id @default(autoincrement())
  studentId  Int
  fromRole   String
  message    String
  attachment String?
  createdAt  DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [id])
}
